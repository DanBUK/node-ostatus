var Vows = require('vows'),
    Assert = require('assert'),
    Salmon = require('../lib/ostatus/salmon');

Vows.describe('Salmon').addBatch({

    generate: {
	'should work': {
		// TODO: topics return instead of callback
		topic: function() {
		    this.key = Salmon.generateKeys();
		    this.callback();
		},
		'must have public key': function() {
		    Assert.ok(this.key.public.match(/^RSA\..+\..+/));
		},
		'must have private key': function() {
		    Assert.ok(typeof this.key.private === 'string');
		},
		'can be used to sign': {
		    topic: function() {
			this.me = { data: 'Hello World',
				    data_type: 'application/test' };
			this.sig = Salmon.generateSignature(this.me, this.key.private);
			this.callback();
		    },
		    'signature generated': function() {
			//Assert.equal(this.sig.length, 256);
		    },
		    'can be verified': {
			topic: function() {
console.log({verify:[this.me,this.sig,this.key.public]})
			    this.verified1 = Salmon.verifySignature(this.me, this.sig, this.key.public);
			    this.callback();
			},
			'verification successful': function() {
			    Assert.ok(this.verified1);
			}
		    }
		}
        }
    },

    /* http://code.google.com/p/salmon-protocol/issues/detail?id=8 */
    'invalid spec example': {
	'should work': {
		topic: function() {
		    var pubKey = "RSA.mVgY8RN6URBTstndvmUUPb4UZTdwvwmddSKE5z_jvKUEK6yk1u3rrC9yN8k6FilGj9K0eeUPe2hf4Pj-5CmHww.AQAB";
		    /*var sig = "EvGSD2vi8qYcveHnb-rrlok07qnCXjn8YSeCDDXlbhILSabgvNsPpbe76up8w63i2fWHvLKJzeGLKfyHg8ZomQ";
		    var data = "PD94bWwgdmVyc2lvbj0nMS4wJyBlbmNvZGluZz0nVVRGLTgnPz4KPGVudHJ5IHhtbG5zPS" +
			    "dodHRwOi8vd3d3LnczLm9yZy8yMDA1L0F0b20nPgogIDxpZD50YWc6ZXhhbXBsZS5jb20s" +
			    "MjAwOTpjbXQtMC40NDc3NTcxODwvaWQ-ICAKICA8YXV0aG9yPjxuYW1lPnRlc3RAZXhhbX" +
			    "BsZS5jb208L25hbWUPHVyaT5hY2N0OmpwYW56ZXJAZ29vZ2xlLmNvbTwvdXJpPjwvYXV0a" +
			    "G9yPgogIDx0aHI6aW4tcmVwbHktdG8geG1sbnM6dGhyPSdodHRwOi8vcHVybC5vcmcvc3l" +
			    "uZGljYXRpb24vdGhyZWFkLzEuMCcKICAgICAgcmVmPSd0YWc6YmxvZ2dlci5jb20sMTk5O" +
			    "TpibG9nLTg5MzU5MTM3NDMxMzMxMjczNy5wb3N0LTM4NjE2NjMyNTg1Mzg4NTc5NTQnPnR" +
			    "hZzpibG9nZ2VyLmNvbSwxOTk5OmJsb2ctODkzNTkxMzc0MzEzMzEyNzM3LnBvc3QtMzg2M" +
			    "TY2MzI1ODUzODg1Nzk1NAogIDwvdGhyOmluLXJlcGx5LXRvPgogIDxjb250ZW50PlNhbG1" +
			    "vbiBzd2ltIHVwc3RyZWFtITwvY29udGVudD4KICA8dGl0bGUU2FsbW9uIHN3aW0gdXBzdH" +
			    "JlYW0hPC90aXRsZT4KICA8dXBkYXRlZD4yMDA5LTEyLTE4VDIwOjA0OjAzWjwvdXBkYXRl" +
			    "ZD4KPC9lbnRyeT4KICAgIA";*/
		    var sig = "UqKwh0XSOhdSD7U9nVHxB67sCNt8lQzkl5aPELQTfuhrlBoktbExhhkP4QGFg0WS0FgPnQpG24z5S4XIk2BTjI8My-VlwRWdeU72NtnLhZjz8EzA1aJTI_Drs71-YICuM_dLAJgo55pF4nIMkRN9KA-rS-y7oC3cwt01MknR8UQ=";
		    var data = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiID8-PGVudHJ5IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDA1L0F0b20iIHhtbG5zOnRocj0iaHR0cDovL3B1cmwub3JnL3N5bmRpY2F0aW9uL3RocmVhZC8xLjAiIHhtbG5zOmFjdGl2aXR5PSJodHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zcGVjLzEuMC8iIHhtbG5zOmdlb3Jzcz0iaHR0cDovL3d3dy5nZW9yc3Mub3JnL2dlb3JzcyIgeG1sbnM6b3N0YXR1cz0iaHR0cDovL29zdGF0dXMub3JnL3NjaGVtYS8xLjAiIHhtbG5zOnBvY289Imh0dHA6Ly9wb3J0YWJsZWNvbnRhY3RzLm5ldC9zcGVjLzEuMCIgeG1sbnM6bWVkaWE9Imh0dHA6Ly9wdXJsLm9yZy9zeW5kaWNhdGlvbi9hdG9tbWVkaWEiIHhtbG5zOnN0YXR1c25ldD0iaHR0cDovL3N0YXR1cy5uZXQvc2NoZW1hL2FwaS8xLyI-CiA8YWN0aXZpdHk6b2JqZWN0LXR5cGU-aHR0cDovL2FjdGl2aXR5c3RyZWEubXMvc2NoZW1hLzEuMC9ub3RlPC9hY3Rpdml0eTpvYmplY3QtdHlwZT4KIDxpZD5odHRwOi8vaWRlbnRpLmNhL25vdGljZS82NTEzOTc5MjwvaWQ-CiA8dGl0bGU-dGhpcyBvbmUgaXMgZm9yIEBjYXBhQGVzY2hlbmF1ZXIuYmUgLSBlbmpveSAhPC90aXRsZT4KIDxjb250ZW50IHR5cGU9Imh0bWwiPnRoaXMgb25lIGlzIGZvciBAJmx0O3NwYW4gY2xhc3M9JnF1b3Q7dmNhcmQmcXVvdDsmZ3Q7Jmx0O2EgaHJlZj0mcXVvdDtodHRwOi8vZXNjaGVuYXVlci5iZS91c2Vycy9jYXBhJnF1b3Q7IGNsYXNzPSZxdW90O3VybCZxdW90OyZndDsmbHQ7c3BhbiBjbGFzcz0mcXVvdDtmbiBuaWNrbmFtZSZxdW90OyZndDtjYXBhQGVzY2hlbmF1ZXIuYmUmbHQ7L3NwYW4mZ3Q7Jmx0Oy9hJmd0OyZsdDsvc3BhbiZndDsgLSBlbmpveSAhPC9jb250ZW50PgogPGxpbmsgcmVsPSJhbHRlcm5hdGUiIHR5cGU9InRleHQvaHRtbCIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS9ub3RpY2UvNjUxMzk3OTIiLz4KIDxhY3Rpdml0eTp2ZXJiPmh0dHA6Ly9hY3Rpdml0eXN0cmVhLm1zL3NjaGVtYS8xLjAvcG9zdDwvYWN0aXZpdHk6dmVyYj4KIDxwdWJsaXNoZWQ-MjAxMS0wMi0yMlQyMToyMjo0OSswMDowMDwvcHVibGlzaGVkPgogPHVwZGF0ZWQ-MjAxMS0wMi0yMlQyMToyMjo0OSswMDowMDwvdXBkYXRlZD4KIDxhdXRob3I-CiAgPGFjdGl2aXR5Om9iamVjdC10eXBlPmh0dHA6Ly9hY3Rpdml0eXN0cmVhLm1zL3NjaGVtYS8xLjAvcGVyc29uPC9hY3Rpdml0eTpvYmplY3QtdHlwZT4KICA8dXJpPmh0dHA6Ly9pZGVudGkuY2EvdXNlci8zODUyMTY8L3VyaT4KICA8bmFtZT5zaG91dHI8L25hbWU-CiAgPGxpbmsgcmVsPSJhbHRlcm5hdGUiIHR5cGU9InRleHQvaHRtbCIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS9zaG91dHIiLz4KICA8bGluayByZWw9ImF2YXRhciIgdHlwZT0iaW1hZ2UvcG5nIiBtZWRpYTp3aWR0aD0iOTYiIG1lZGlhOmhlaWdodD0iOTYiIGhyZWY9Imh0dHA6Ly90aGVtZS5pZGVudGkuY2EvMC45LjdiZXRhMi9pZGVudGljYS9kZWZhdWx0LWF2YXRhci1wcm9maWxlLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI0OCIgbWVkaWE6aGVpZ2h0PSI0OCIgaHJlZj0iaHR0cDovL3RoZW1lLmlkZW50aS5jYS8wLjkuN2JldGEyL2lkZW50aWNhL2RlZmF1bHQtYXZhdGFyLXN0cmVhbS5wbmciLz4KICA8bGluayByZWw9ImF2YXRhciIgdHlwZT0iaW1hZ2UvcG5nIiBtZWRpYTp3aWR0aD0iMjQiIG1lZGlhOmhlaWdodD0iMjQiIGhyZWY9Imh0dHA6Ly90aGVtZS5pZGVudGkuY2EvMC45LjdiZXRhMi9pZGVudGljYS9kZWZhdWx0LWF2YXRhci1taW5pLnBuZyIvPgogIDxwb2NvOnByZWZlcnJlZFVzZXJuYW1lPnNob3V0cjwvcG9jbzpwcmVmZXJyZWRVc2VybmFtZT4KICA8cG9jbzpkaXNwbGF5TmFtZT5TaG91dHI8L3BvY286ZGlzcGxheU5hbWU-CiAgPHBvY286dXJscz4KICAgPHBvY286dHlwZT5ob21lcGFnZTwvcG9jbzp0eXBlPgogICA8cG9jbzp2YWx1ZT5odHRwOi8vc2hvdXRyLm9yZzwvcG9jbzp2YWx1ZT4KICAgPHBvY286cHJpbWFyeT50cnVlPC9wb2NvOnByaW1hcnk-CjwvcG9jbzp1cmxzPgo8L2F1dGhvcj4KIDwhLS1EZXByZWNhdGlvbiB3YXJuaW5nOiBhY3Rpdml0eTphY3RvciBpcyBwcmVzZW50IG9ubHkgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuIEl0IHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCB2ZXJzaW9uIG9mIFN0YXR1c05ldC4tLT4KIDxhY3Rpdml0eTphY3Rvcj4KICA8YWN0aXZpdHk6b2JqZWN0LXR5cGU-aHR0cDovL2FjdGl2aXR5c3RyZWEubXMvc2NoZW1hLzEuMC9wZXJzb248L2FjdGl2aXR5Om9iamVjdC10eXBlPgogIDxpZD5odHRwOi8vaWRlbnRpLmNhL3VzZXIvMzg1MjE2PC9pZD4KICA8dGl0bGU-U2hvdXRyPC90aXRsZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vaWRlbnRpLmNhL3Nob3V0ciIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI5NiIgbWVkaWE6aGVpZ2h0PSI5NiIgaHJlZj0iaHR0cDovL3RoZW1lLmlkZW50aS5jYS8wLjkuN2JldGEyL2lkZW50aWNhL2RlZmF1bHQtYXZhdGFyLXByb2ZpbGUucG5nIi8-CiAgPGxpbmsgcmVsPSJhdmF0YXIiIHR5cGU9ImltYWdlL3BuZyIgbWVkaWE6d2lkdGg9IjQ4IiBtZWRpYTpoZWlnaHQ9IjQ4IiBocmVmPSJodHRwOi8vdGhlbWUuaWRlbnRpLmNhLzAuOS43YmV0YTIvaWRlbnRpY2EvZGVmYXVsdC1hdmF0YXItc3RyZWFtLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSIyNCIgbWVkaWE6aGVpZ2h0PSIyNCIgaHJlZj0iaHR0cDovL3RoZW1lLmlkZW50aS5jYS8wLjkuN2JldGEyL2lkZW50aWNhL2RlZmF1bHQtYXZhdGFyLW1pbmkucG5nIi8-CiAgPHBvY286cHJlZmVycmVkVXNlcm5hbWU-c2hvdXRyPC9wb2NvOnByZWZlcnJlZFVzZXJuYW1lPgogIDxwb2NvOmRpc3BsYXlOYW1lPlNob3V0cjwvcG9jbzpkaXNwbGF5TmFtZT4KICA8cG9jbzp1cmxzPgogICA8cG9jbzp0eXBlPmhvbWVwYWdlPC9wb2NvOnR5cGU-CiAgIDxwb2NvOnZhbHVlPmh0dHA6Ly9zaG91dHIub3JnPC9wb2NvOnZhbHVlPgogICA8cG9jbzpwcmltYXJ5PnRydWU8L3BvY286cHJpbWFyeT4KPC9wb2NvOnVybHM-CjwvYWN0aXZpdHk6YWN0b3I-CiA8bGluayByZWw9Im9zdGF0dXM6Y29udmVyc2F0aW9uIiBocmVmPSJodHRwOi8vaWRlbnRpLmNhL2NvbnZlcnNhdGlvbi82NDM4Mjk1NSIvPgogPGxpbmsgcmVsPSJvc3RhdHVzOmF0dGVudGlvbiIgaHJlZj0iaHR0cDovL2VzY2hlbmF1ZXIuYmUvdXNlcnMvY2FwYSIvPgogPGxpbmsgcmVsPSJtZW50aW9uZWQiIGhyZWY9Imh0dHA6Ly9lc2NoZW5hdWVyLmJlL3VzZXJzL2NhcGEiLz4KIDxnZW9yc3M6cG9pbnQ-NTAuNTY2NjcgNS41ODMzMzwvZ2VvcnNzOnBvaW50PgogPHNvdXJjZT4KICA8aWQ-aHR0cDovL2VzY2hlbmF1ZXIuYmUvdXBkYXRlcy9jYXBhLmF0b208L2lkPgogIDx0aXRsZT5jYXBhPC90aXRsZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vZXNjaGVuYXVlci5iZS91c2Vycy9jYXBhIi8-CiAgPGxpbmsgcmVsPSJzZWxmIiB0eXBlPSJhcHBsaWNhdGlvbi9hdG9tK3htbCIgaHJlZj0iaHR0cDovL2VzY2hlbmF1ZXIuYmUvdXBkYXRlcy9jYXBhLmF0b20iLz4KICA8aWNvbj5odHRwOi8vdGhlbWUuaWRlbnRpLmNhLzAuOS43YmV0YTIvaWRlbnRpY2EvZGVmYXVsdC1hdmF0YXItcHJvZmlsZS5wbmc8L2ljb24-Cjwvc291cmNlPgogPGxpbmsgcmVsPSJzZWxmIiB0eXBlPSJhcHBsaWNhdGlvbi9hdG9tK3htbCIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS9hcGkvc3RhdHVzZXMvc2hvdy82NTEzOTc5Mi5hdG9tIi8-CiA8bGluayByZWw9ImVkaXQiIHR5cGU9ImFwcGxpY2F0aW9uL2F0b20reG1sIiBocmVmPSJodHRwOi8vaWRlbnRpLmNhL2FwaS9zdGF0dXNlcy9zaG93LzY1MTM5NzkyLmF0b20iLz4KIDxzdGF0dXNuZXQ6bm90aWNlX2luZm8gbG9jYWxfaWQ9IjY1MTM5NzkyIiBzb3VyY2U9IndlYiI-PC9zdGF0dXNuZXQ6bm90aWNlX2luZm8-CjwvZW50cnk-Cg==";
		    var data_type = "application/atom+xml";
console.log({dsig:Salmon.base64url_decode(sig),data:Salmon.base64url_decode(data).toString()});
		    this.verified2 = Salmon.verifySignature({ data: Salmon.base64url_decode(data),
							      data_type: data_type },
							    Salmon.base64url_decode(sig), pubKey);
		    this.callback();
		},
		verifies: function() {
		    Assert.ok(this.verified2);
		}
	}
    },

    'OStatus test': {
	/* I received a Salmon from OStatus */
	'JSON': {
	    topic: function() {
		var pubKey = "RSA.jlPJrc6Y44RP0XrQ5BE8xhCuM3QCc-ZbC0KBdFlL6lfl3KhuWkgtVHR--IdcCDht753ieN_3PlLqFBIgxwWkkwMP4Kmsh7FHO9tnmBo4NV_7E8QUCpIfg9b0wieyncvACG2laAuPOLvJOmle7d05diSmsoQTLs_dJwKJ8XHFgfE=.AQAB";
		var me = { data_type: "application/atom+xml",
			   data: "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiID8-PGVudHJ5IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDA1L0F0b20iIHhtbG5zOnRocj0iaHR0cDovL3B1cmwub3JnL3N5bmRpY2F0aW9uL3RocmVhZC8xLjAiIHhtbG5zOmFjdGl2aXR5PSJodHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zcGVjLzEuMC8iIHhtbG5zOmdlb3Jzcz0iaHR0cDovL3d3dy5nZW9yc3Mub3JnL2dlb3JzcyIgeG1sbnM6b3N0YXR1cz0iaHR0cDovL29zdGF0dXMub3JnL3NjaGVtYS8xLjAiIHhtbG5zOnBvY289Imh0dHA6Ly9wb3J0YWJsZWNvbnRhY3RzLm5ldC9zcGVjLzEuMCIgeG1sbnM6bWVkaWE9Imh0dHA6Ly9wdXJsLm9yZy9zeW5kaWNhdGlvbi9hdG9tbWVkaWEiIHhtbG5zOnN0YXR1c25ldD0iaHR0cDovL3N0YXR1cy5uZXQvc2NoZW1hL2FwaS8xLyI-CiA8YWN0aXZpdHk6b2JqZWN0LXR5cGU-aHR0cDovL2FjdGl2aXR5c3RyZWEubXMvc2NoZW1hLzEuMC9ub3RlPC9hY3Rpdml0eTpvYmplY3QtdHlwZT4KIDxpZD5odHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9ub3RpY2UvMjwvaWQ-CiA8dGl0bGU-QGFzdHJvQHNwYWNlYm95ei5uZXQgSGVsbG8gV29ybGQ8L3RpdGxlPgogPGNvbnRlbnQgdHlwZT0iaHRtbCI-QCZsdDtzcGFuIGNsYXNzPSZxdW90O3ZjYXJkJnF1b3Q7Jmd0OyZsdDthIGhyZWY9JnF1b3Q7aHR0cDovL2lkZW50aS5jYS9hc3RybyZxdW90OyBjbGFzcz0mcXVvdDt1cmwmcXVvdDsmZ3Q7Jmx0O3NwYW4gY2xhc3M9JnF1b3Q7Zm4gbmlja25hbWUmcXVvdDsmZ3Q7YXN0cm9Ac3BhY2Vib3l6Lm5ldCZsdDsvc3BhbiZndDsmbHQ7L2EmZ3Q7Jmx0Oy9zcGFuJmd0OyBIZWxsbyBXb3JsZDwvY29udGVudD4KIDxsaW5rIHJlbD0iYWx0ZXJuYXRlIiB0eXBlPSJ0ZXh0L2h0bWwiIGhyZWY9Imh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL25vdGljZS8yIi8-CiA8YWN0aXZpdHk6dmVyYj5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3Bvc3Q8L2FjdGl2aXR5OnZlcmI-CiA8cHVibGlzaGVkPjIwMTEtMDYtMjBUMjM6MzE6MDArMDA6MDA8L3B1Ymxpc2hlZD4KIDx1cGRhdGVkPjIwMTEtMDYtMjBUMjM6MzE6MDArMDA6MDA8L3VwZGF0ZWQ-CiA8YXV0aG9yPgogIDxhY3Rpdml0eTpvYmplY3QtdHlwZT5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3BlcnNvbjwvYWN0aXZpdHk6b2JqZWN0LXR5cGU-CiAgPHVyaT5odHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy91c2VyLzI8L3VyaT4KICA8bmFtZT5hc3RybzwvbmFtZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hc3RybyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI5NiIgbWVkaWE6aGVpZ2h0PSI5NiIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1wcm9maWxlLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI0OCIgbWVkaWE6aGVpZ2h0PSI0OCIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1zdHJlYW0ucG5nIi8-CiAgPGxpbmsgcmVsPSJhdmF0YXIiIHR5cGU9ImltYWdlL3BuZyIgbWVkaWE6d2lkdGg9IjI0IiBtZWRpYTpoZWlnaHQ9IjI0IiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy90aGVtZS9kZWZhdWx0L2RlZmF1bHQtYXZhdGFyLW1pbmkucG5nIi8-CiAgPHBvY286cHJlZmVycmVkVXNlcm5hbWU-YXN0cm88L3BvY286cHJlZmVycmVkVXNlcm5hbWU-CiAgPHBvY286ZGlzcGxheU5hbWU-YXN0cm88L3BvY286ZGlzcGxheU5hbWU-CiAgPHN0YXR1c25ldDpwcm9maWxlX2luZm8gbG9jYWxfaWQ9IjIiPjwvc3RhdHVzbmV0OnByb2ZpbGVfaW5mbz4KIDwvYXV0aG9yPgogPCEtLURlcHJlY2F0aW9uIHdhcm5pbmc6IGFjdGl2aXR5OmFjdG9yIGlzIHByZXNlbnQgb25seSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gSXQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IHZlcnNpb24gb2YgU3RhdHVzTmV0Li0tPgogPGFjdGl2aXR5OmFjdG9yPgogIDxhY3Rpdml0eTpvYmplY3QtdHlwZT5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3BlcnNvbjwvYWN0aXZpdHk6b2JqZWN0LXR5cGU-CiAgPGlkPmh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL3VzZXIvMjwvaWQ-CiAgPHRpdGxlPmFzdHJvPC90aXRsZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hc3RybyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI5NiIgbWVkaWE6aGVpZ2h0PSI5NiIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1wcm9maWxlLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI0OCIgbWVkaWE6aGVpZ2h0PSI0OCIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1zdHJlYW0ucG5nIi8-CiAgPGxpbmsgcmVsPSJhdmF0YXIiIHR5cGU9ImltYWdlL3BuZyIgbWVkaWE6d2lkdGg9IjI0IiBtZWRpYTpoZWlnaHQ9IjI0IiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy90aGVtZS9kZWZhdWx0L2RlZmF1bHQtYXZhdGFyLW1pbmkucG5nIi8-CiAgPHBvY286cHJlZmVycmVkVXNlcm5hbWU-YXN0cm88L3BvY286cHJlZmVycmVkVXNlcm5hbWU-CiAgPHBvY286ZGlzcGxheU5hbWU-YXN0cm88L3BvY286ZGlzcGxheU5hbWU-CiAgPHN0YXR1c25ldDpwcm9maWxlX2luZm8gbG9jYWxfaWQ9IjIiPjwvc3RhdHVzbmV0OnByb2ZpbGVfaW5mbz4KIDwvYWN0aXZpdHk6YWN0b3I-CiA8bGluayByZWw9Im9zdGF0dXM6Y29udmVyc2F0aW9uIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9jb252ZXJzYXRpb24vMiIvPgogPGxpbmsgcmVsPSJvc3RhdHVzOmF0dGVudGlvbiIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS91c2VyLzE1OTEiLz4KIDxsaW5rIHJlbD0ibWVudGlvbmVkIiBocmVmPSJodHRwOi8vaWRlbnRpLmNhL3VzZXIvMTU5MSIvPgogPHNvdXJjZT4KICA8aWQ-aHR0cDovL2lkZW50aS5jYS9hcGkvc3RhdHVzZXMvdXNlcl90aW1lbGluZS8xNTkxLmF0b208L2lkPgogIDx0aXRsZT5Bc3RybzwvdGl0bGU-CiAgPGxpbmsgcmVsPSJhbHRlcm5hdGUiIHR5cGU9InRleHQvaHRtbCIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS9hc3RybyIvPgogIDxsaW5rIHJlbD0ic2VsZiIgdHlwZT0iYXBwbGljYXRpb24vYXRvbSt4bWwiIGhyZWY9Imh0dHA6Ly9pZGVudGkuY2EvYXBpL3N0YXR1c2VzL3VzZXJfdGltZWxpbmUvMTU5MS5hdG9tIi8-CiAgPGljb24-aHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvYXZhdGFyLzMtb3JpZ2luYWwtMjAxMTA2MjAyMjMzMzEuZ2lmPC9pY29uPgogPC9zb3VyY2U-CiA8bGluayByZWw9InNlbGYiIHR5cGU9ImFwcGxpY2F0aW9uL2F0b20reG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hcGkvc3RhdHVzZXMvc2hvdy8yLmF0b20iLz4KIDxsaW5rIHJlbD0iZWRpdCIgdHlwZT0iYXBwbGljYXRpb24vYXRvbSt4bWwiIGhyZWY9Imh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL2FwaS9zdGF0dXNlcy9zaG93LzIuYXRvbSIvPgogPHN0YXR1c25ldDpub3RpY2VfaW5mbyBsb2NhbF9pZD0iMiIgc291cmNlPSJ3ZWIiPjwvc3RhdHVzbmV0Om5vdGljZV9pbmZvPgo8L2VudHJ5Pgo=",
			   encoding: "base64url",
			   alg: "RSA-SHA256",
			   sigs: [{ value: "Dco1Z_IJxKqAnDjvbvXqQRR13jZJc0WXhn8v3ou4YgiDA8-f5aGh5LNVFYATwm5vn1aa5KA-cG7WmynIZv_HoStCMvcxBfBXetTKlcIuo1AmhBEzmpbWQPGlCnfOn_nnIFzh0fBMkTB-5xf01MaydtMNdLzkYKgMlaSw16bSn64=" }]
			 };
console.log('verifying')
		return Salmon.verifyEnvelopeJSON(me, pubKey);
console.log('verified')
	    },
	    'verifies': function(verified) {
		Assert.ok(verified, 'Verified');
	    }
	},
	'XML': {
	    topic: function() {
		var xml = '<?xml version="1.0" encoding="UTF-8"?><me:env xmlns:me="http://salmon-protocol.org/ns/magic-env"><me:data type="application/atom+xml">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiID8-PGVudHJ5IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDA1L0F0b20iIHhtbG5zOnRocj0iaHR0cDovL3B1cmwub3JnL3N5bmRpY2F0aW9uL3RocmVhZC8xLjAiIHhtbG5zOmFjdGl2aXR5PSJodHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zcGVjLzEuMC8iIHhtbG5zOmdlb3Jzcz0iaHR0cDovL3d3dy5nZW9yc3Mub3JnL2dlb3JzcyIgeG1sbnM6b3N0YXR1cz0iaHR0cDovL29zdGF0dXMub3JnL3NjaGVtYS8xLjAiIHhtbG5zOnBvY289Imh0dHA6Ly9wb3J0YWJsZWNvbnRhY3RzLm5ldC9zcGVjLzEuMCIgeG1sbnM6bWVkaWE9Imh0dHA6Ly9wdXJsLm9yZy9zeW5kaWNhdGlvbi9hdG9tbWVkaWEiIHhtbG5zOnN0YXR1c25ldD0iaHR0cDovL3N0YXR1cy5uZXQvc2NoZW1hL2FwaS8xLyI-CiA8YWN0aXZpdHk6b2JqZWN0LXR5cGU-aHR0cDovL2FjdGl2aXR5c3RyZWEubXMvc2NoZW1hLzEuMC9ub3RlPC9hY3Rpdml0eTpvYmplY3QtdHlwZT4KIDxpZD5odHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9ub3RpY2UvMjwvaWQ-CiA8dGl0bGU-QGFzdHJvQHNwYWNlYm95ei5uZXQgSGVsbG8gV29ybGQ8L3RpdGxlPgogPGNvbnRlbnQgdHlwZT0iaHRtbCI-QCZsdDtzcGFuIGNsYXNzPSZxdW90O3ZjYXJkJnF1b3Q7Jmd0OyZsdDthIGhyZWY9JnF1b3Q7aHR0cDovL2lkZW50aS5jYS9hc3RybyZxdW90OyBjbGFzcz0mcXVvdDt1cmwmcXVvdDsmZ3Q7Jmx0O3NwYW4gY2xhc3M9JnF1b3Q7Zm4gbmlja25hbWUmcXVvdDsmZ3Q7YXN0cm9Ac3BhY2Vib3l6Lm5ldCZsdDsvc3BhbiZndDsmbHQ7L2EmZ3Q7Jmx0Oy9zcGFuJmd0OyBIZWxsbyBXb3JsZDwvY29udGVudD4KIDxsaW5rIHJlbD0iYWx0ZXJuYXRlIiB0eXBlPSJ0ZXh0L2h0bWwiIGhyZWY9Imh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL25vdGljZS8yIi8-CiA8YWN0aXZpdHk6dmVyYj5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3Bvc3Q8L2FjdGl2aXR5OnZlcmI-CiA8cHVibGlzaGVkPjIwMTEtMDYtMjBUMjM6MzE6MDArMDA6MDA8L3B1Ymxpc2hlZD4KIDx1cGRhdGVkPjIwMTEtMDYtMjBUMjM6MzE6MDArMDA6MDA8L3VwZGF0ZWQ-CiA8YXV0aG9yPgogIDxhY3Rpdml0eTpvYmplY3QtdHlwZT5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3BlcnNvbjwvYWN0aXZpdHk6b2JqZWN0LXR5cGU-CiAgPHVyaT5odHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy91c2VyLzI8L3VyaT4KICA8bmFtZT5hc3RybzwvbmFtZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hc3RybyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI5NiIgbWVkaWE6aGVpZ2h0PSI5NiIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1wcm9maWxlLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI0OCIgbWVkaWE6aGVpZ2h0PSI0OCIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1zdHJlYW0ucG5nIi8-CiAgPGxpbmsgcmVsPSJhdmF0YXIiIHR5cGU9ImltYWdlL3BuZyIgbWVkaWE6d2lkdGg9IjI0IiBtZWRpYTpoZWlnaHQ9IjI0IiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy90aGVtZS9kZWZhdWx0L2RlZmF1bHQtYXZhdGFyLW1pbmkucG5nIi8-CiAgPHBvY286cHJlZmVycmVkVXNlcm5hbWU-YXN0cm88L3BvY286cHJlZmVycmVkVXNlcm5hbWU-CiAgPHBvY286ZGlzcGxheU5hbWU-YXN0cm88L3BvY286ZGlzcGxheU5hbWU-CiAgPHN0YXR1c25ldDpwcm9maWxlX2luZm8gbG9jYWxfaWQ9IjIiPjwvc3RhdHVzbmV0OnByb2ZpbGVfaW5mbz4KIDwvYXV0aG9yPgogPCEtLURlcHJlY2F0aW9uIHdhcm5pbmc6IGFjdGl2aXR5OmFjdG9yIGlzIHByZXNlbnQgb25seSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gSXQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IHZlcnNpb24gb2YgU3RhdHVzTmV0Li0tPgogPGFjdGl2aXR5OmFjdG9yPgogIDxhY3Rpdml0eTpvYmplY3QtdHlwZT5odHRwOi8vYWN0aXZpdHlzdHJlYS5tcy9zY2hlbWEvMS4wL3BlcnNvbjwvYWN0aXZpdHk6b2JqZWN0LXR5cGU-CiAgPGlkPmh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL3VzZXIvMjwvaWQ-CiAgPHRpdGxlPmFzdHJvPC90aXRsZT4KICA8bGluayByZWw9ImFsdGVybmF0ZSIgdHlwZT0idGV4dC9odG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hc3RybyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI5NiIgbWVkaWE6aGVpZ2h0PSI5NiIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1wcm9maWxlLnBuZyIvPgogIDxsaW5rIHJlbD0iYXZhdGFyIiB0eXBlPSJpbWFnZS9wbmciIG1lZGlhOndpZHRoPSI0OCIgbWVkaWE6aGVpZ2h0PSI0OCIgaHJlZj0iaHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvdGhlbWUvZGVmYXVsdC9kZWZhdWx0LWF2YXRhci1zdHJlYW0ucG5nIi8-CiAgPGxpbmsgcmVsPSJhdmF0YXIiIHR5cGU9ImltYWdlL3BuZyIgbWVkaWE6d2lkdGg9IjI0IiBtZWRpYTpoZWlnaHQ9IjI0IiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy90aGVtZS9kZWZhdWx0L2RlZmF1bHQtYXZhdGFyLW1pbmkucG5nIi8-CiAgPHBvY286cHJlZmVycmVkVXNlcm5hbWU-YXN0cm88L3BvY286cHJlZmVycmVkVXNlcm5hbWU-CiAgPHBvY286ZGlzcGxheU5hbWU-YXN0cm88L3BvY286ZGlzcGxheU5hbWU-CiAgPHN0YXR1c25ldDpwcm9maWxlX2luZm8gbG9jYWxfaWQ9IjIiPjwvc3RhdHVzbmV0OnByb2ZpbGVfaW5mbz4KIDwvYWN0aXZpdHk6YWN0b3I-CiA8bGluayByZWw9Im9zdGF0dXM6Y29udmVyc2F0aW9uIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9jb252ZXJzYXRpb24vMiIvPgogPGxpbmsgcmVsPSJvc3RhdHVzOmF0dGVudGlvbiIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS91c2VyLzE1OTEiLz4KIDxsaW5rIHJlbD0ibWVudGlvbmVkIiBocmVmPSJodHRwOi8vaWRlbnRpLmNhL3VzZXIvMTU5MSIvPgogPHNvdXJjZT4KICA8aWQ-aHR0cDovL2lkZW50aS5jYS9hcGkvc3RhdHVzZXMvdXNlcl90aW1lbGluZS8xNTkxLmF0b208L2lkPgogIDx0aXRsZT5Bc3RybzwvdGl0bGU-CiAgPGxpbmsgcmVsPSJhbHRlcm5hdGUiIHR5cGU9InRleHQvaHRtbCIgaHJlZj0iaHR0cDovL2lkZW50aS5jYS9hc3RybyIvPgogIDxsaW5rIHJlbD0ic2VsZiIgdHlwZT0iYXBwbGljYXRpb24vYXRvbSt4bWwiIGhyZWY9Imh0dHA6Ly9pZGVudGkuY2EvYXBpL3N0YXR1c2VzL3VzZXJfdGltZWxpbmUvMTU5MS5hdG9tIi8-CiAgPGljb24-aHR0cDovL2FzdHJvLnN0YXR1c25ldC5mZG1ieC5vcmcvYXZhdGFyLzMtb3JpZ2luYWwtMjAxMTA2MjAyMjMzMzEuZ2lmPC9pY29uPgogPC9zb3VyY2U-CiA8bGluayByZWw9InNlbGYiIHR5cGU9ImFwcGxpY2F0aW9uL2F0b20reG1sIiBocmVmPSJodHRwOi8vYXN0cm8uc3RhdHVzbmV0LmZkbWJ4Lm9yZy9hcGkvc3RhdHVzZXMvc2hvdy8yLmF0b20iLz4KIDxsaW5rIHJlbD0iZWRpdCIgdHlwZT0iYXBwbGljYXRpb24vYXRvbSt4bWwiIGhyZWY9Imh0dHA6Ly9hc3Ryby5zdGF0dXNuZXQuZmRtYngub3JnL2FwaS9zdGF0dXNlcy9zaG93LzIuYXRvbSIvPgogPHN0YXR1c25ldDpub3RpY2VfaW5mbyBsb2NhbF9pZD0iMiIgc291cmNlPSJ3ZWIiPjwvc3RhdHVzbmV0Om5vdGljZV9pbmZvPgo8L2VudHJ5Pgo=</me:data><me:encoding>base64url</me:encoding><me:alg>RSA-SHA256</me:alg><me:sig>Dco1Z_IJxKqAnDjvbvXqQRR13jZJc0WXhn8v3ou4YgiDA8-f5aGh5LNVFYATwm5vn1aa5KA-cG7WmynIZv_HoStCMvcxBfBXetTKlcIuo1AmhBEzmpbWQPGlCnfOn_nnIFzh0fBMkTB-5xf01MaydtMNdLzkYKgMlaSw16bSn64=</me:sig></me:env>';
	    }
	}
    }

    /* More test cases can be found at:
     * http://code.google.com/p/salmon-protocol/source/browse/trunk/lib/python/magicsig/magicsig_test.py
     */

}).run();
